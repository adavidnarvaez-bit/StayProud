<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reservas | StayProud</title>

  <!-- Flatpickr (calendario) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root{
      --primary:#00bfa6;
      --bg:#f6f7f9;
      --card:#fff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

    .site-header{
      background:linear-gradient(90deg,var(--primary),#11a89a);
      color:#fff;padding:14px 18px;position:sticky;top:0;z-index:10
    }
    .nav-wrap{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;font-weight:900}
    .brand img{width:34px;height:34px;background:#fff;border-radius:10px;padding:4px;object-fit:contain}
    .main-nav{display:flex;gap:10px;flex-wrap:wrap}
    .main-nav a{color:#eafffb;text-decoration:none;padding:8px 10px;border-radius:999px;font-weight:700;font-size:14px;border:1px solid rgba(255,255,255,.22)}
    .main-nav a.active{background:rgba(255,255,255,.18);border-color:rgba(255,255,255,.35)}

    .page{
      max-width:1100px;margin:18px auto;padding:0 16px 28px;
      display:grid;grid-template-columns:1.2fr .8fr;gap:16px
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(16,24,40,.06)}
    .card-header{padding:16px 16px 10px;border-bottom:1px solid var(--border)}
    .card-header h1{margin:0;font-size:20px}
    .card-header p{margin:6px 0 0;color:var(--muted);font-size:14px;line-height:1.4}

    .content{padding:14px 16px 18px}
    .legend{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;color:var(--muted);font-size:13px;font-weight:700}
    .dot{width:14px;height:14px;border-radius:4px;border:1px solid var(--border);display:inline-block}
    .dot.free{background:#fff}
    .dot.inquiry{background:#fde68a;border-color:#f59e0b55}
    .dot.reserved{background:var(--primary);border-color:transparent}

    label{display:block;font-size:12px;color:var(--muted);font-weight:800;margin-bottom:6px}
    input,select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      outline:none;font-size:14px;background:#fff
    }
    input:focus,select:focus{border-color:#00bfa6aa;box-shadow:0 0 0 4px #00bfa61f}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .totals{margin-top:12px;border-top:1px solid var(--border);padding-top:12px;display:grid;gap:6px;color:var(--muted);font-weight:800}
    .totals b{color:var(--text)}
    .total-big{margin-top:6px;font-size:18px;font-weight:900;color:var(--text)}

    .btn{
      width:100%;border:none;background:var(--primary);color:#fff;font-weight:900;
      padding:12px 14px;border-radius:14px;cursor:pointer;letter-spacing:.2px
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn.secondary{background:#fff;color:var(--primary);border:2px solid var(--primary)}

    .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .actions .btn{flex:1;min-width:180px}

    /* Flatpickr: que se vea tipo app */
    .flatpickr-calendar.inline{box-shadow:none;border:0;background:transparent}
    .flatpickr-months .flatpickr-month{color:var(--text)}
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange{
      background:var(--primary)!important;border-color:var(--primary)!important;color:#fff!important
    }
    .flatpickr-day.inRange{background:#00bfa61a!important;border-color:#00bfa600!important}
    .flatpickr-day.is-reserved{background:var(--primary)!important;color:#fff!important;opacity:.85;cursor:not-allowed}
    .flatpickr-day.is-inquiry{background:#fde68a!important;border-color:#f59e0b55!important}

    /* Sección PayPal */
    #paypalBox{display:none;margin-top:14px;border-top:1px solid var(--border);padding-top:14px}
    .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}

    @media (max-width: 900px){
      .page{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="nav-wrap">
      <a class="brand" href="index.html">
        <img src="img/logo.png" alt="StayProud" />
        <span>StayProud</span>
      </a>

      <nav class="main-nav">
        <a href="index.html">Inicio</a>
        <a href="servicios.html">Servicios</a>
        <a href="nosotros.html">Nosotros</a>
        <a href="alojamientos.html">Alojamientos</a>
        <a class="active" href="reservas.html">Reservas</a>
        <a href="contactanos.html">Contáctanos</a>
      </nav>
    </div>
  </header>

  <main class="page">
    <section class="card">
      <div class="card-header">
        <h1>Selecciona las fechas de tu estancia</h1>
        <p>Elige entrada y salida. Las fechas reservadas quedan bloqueadas.</p>
      </div>

      <div class="content">
        <div class="legend">
          <span><i class="dot free"></i> Libre</span>
          <span><i class="dot inquiry"></i> Consulta / Interesado</span>
          <span><i class="dot reserved"></i> Reservado</span>
        </div>

        <!-- Calendario INLINE (siempre visible) -->
        <div id="calendar"></div>

        <div class="hint">
          Si alguna vez no se ve, revisa F12 → Console. Si hay error en rojo, el calendario no puede cargar.
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="card-header">
        <h1>Tu reserva</h1>
        <p>Calculamos noches y total automáticamente.</p>
      </div>

      <div class="content">
        <div class="grid2">
          <div>
            <label>Fecha de entrada</label>
            <input id="checkin" type="text" readonly placeholder="Selecciona en el calendario">
          </div>
          <div>
            <label>Fecha de salida</label>
            <input id="checkout" type="text" readonly placeholder="Selecciona en el calendario">
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid2">
          <div>
            <label>Tipo de habitación</label>
            <select id="roomType">
              <option value="single" data-price="60">Habitación por persona — 60 €/noche</option>
              <option value="couple" data-price="80">Habitación por pareja — 80 €/noche</option>
              <option value="entire" data-price="120">Alojamiento entero — 120 €/noche</option>
            </select>
          </div>
          <div>
            <label>Huéspedes</label>
            <select id="guests">
              <option>1</option><option selected>2</option><option>3</option><option>4</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="grid2">
          <div>
            <label>Nombre y apellidos</label>
            <input id="fullname" type="text" placeholder="Tu nombre completo">
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="tucorreo@gmail.com">
          </div>
        </div>

        <div class="totals">
          <div>Noches: <b id="nights">0</b></div>
          <div>Precio por noche: <b id="priceNight">0 €</b></div>
          <div>Valor por las noches reservadas: <b id="subtotal">0 €</b></div>
          <div class="total-big">Total reserva: <span id="total">0 €</span></div>
        </div>

        <div class="actions">
          <button class="btn secondary" id="clearDates">Borrar fechas</button>
          <button class="btn" id="confirm" disabled>Confirmar reserva</button>
        </div>

        <!-- Pasarela de pago (PayPal) -->
        <div id="paypalBox">
          <h3 style="margin:0 0 8px;">Paga tu reserva</h3>
          <div id="paypal-buttons"></div>
          <div class="hint">En modo pruebas (sandbox). Para producción se cambia el Client ID.</div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Flatpickr -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- PayPal (Sandbox). En producción: reemplaza client-id=TU_CLIENT_ID -->
  <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=EUR"></script>

  <script>
    // ====== BLOQUEOS (ejemplo) ======
    // Formato: "YYYY-MM-DD"
    const reservedRanges = [
      { start: "2025-11-25", end: "2025-11-28" }, // 25-27 ocupadas
      { start: "2025-12-05", end: "2025-12-09" }
    ];
    const inquiryRanges = [
      { start: "2025-11-18", end: "2025-11-20" }
    ];

    // ====== STATE ======
    let startDate = null;
    let endDate = null;

    // ====== DOM ======
    const checkin = document.getElementById("checkin");
    const checkout = document.getElementById("checkout");
    const roomType = document.getElementById("roomType");
    const nightsEl = document.getElementById("nights");
    const priceNightEl = document.getElementById("priceNight");
    const subtotalEl = document.getElementById("subtotal");
    const totalEl = document.getElementById("total");
    const clearDates = document.getElementById("clearDates");
    const confirm = document.getElementById("confirm");
    const paypalBox = document.getElementById("paypalBox");

    const fullname = document.getElementById("fullname");
    const email = document.getElementById("email");

    // ====== HELPERS ======
    const pad2 = n => String(n).padStart(2,"0");
    const toISO = (d) => ${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())};
    const fmtES = (d) => ${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()};

    function inRange(iso, start, end){ return iso >= start && iso < end; }

    function isReservedISO(iso){
      return reservedRanges.some(r => inRange(iso, r.start, r.end));
    }
    function isInquiryISO(iso){
      return inquiryRanges.some(r => inRange(iso, r.start, r.end));
    }

    function calcNights(){
      if(!startDate || !endDate) return 0;
      const ms = endDate.getTime() - startDate.getTime();
      return Math.max(0, Math.round(ms / (1000*60*60*24)));
    }

    function getPricePerNight(){
      const opt = roomType.options[roomType.selectedIndex];
      return Number(opt.dataset.price || 0);
    }

    function recalc(){
      const nights = calcNights();
      const price = getPricePerNight();
      const subtotal = nights * price;

      nightsEl.textContent = String(nights);
      priceNightEl.textContent = ${price} €;
      subtotalEl.textContent = ${subtotal} €;
      totalEl.textContent = ${subtotal} €;

      checkin.value = startDate ? fmtES(startDate) : "";
      checkout.value = endDate ? fmtES(endDate) : "";

      confirm.disabled = !(startDate && endDate && nights > 0);
      paypalBox.style.display = "none"; // si cambias algo, ocultamos pago hasta confirmar
      document.getElementById("paypal-buttons").innerHTML = "";
    }

    // ====== CALENDARIO INLINE ======
    flatpickr("#calendar", {
      inline: true,
      mode: "range",
      dateFormat: "Y-m-d",
      minDate: "today",

      // Bloquear reservadas
      disable: [
        function(date){
          const iso = toISO(date);
          return isReservedISO(iso);
        }
      ],

      // Pintar estilos a días (reservado/inquiry)
      onDayCreate: function(dObj, dStr, fp, dayElem){
        const iso = dayElem.dateObj ? toISO(dayElem.dateObj) : null;
        if(!iso) return;
        if(isReservedISO(iso)) dayElem.classList.add("is-reserved");
        else if(isInquiryISO(iso)) dayElem.classList.add("is-inquiry");
      },

      onChange: function(selectedDates){
        // Flatpickr devuelve [entrada, salida]
        startDate = selectedDates[0] || null;
        endDate = selectedDates[1] || null;

        // Si el usuario elige un rango que “pisa” un reservado (por ejemplo por bug),
        // lo cortamos
        if(startDate && endDate){
          // validar que dentro del rango no haya reservados
          let ok = true;
          for(let d = new Date(startDate); d < endDate; d.setDate(d.getDate()+1)){
            if(isReservedISO(toISO(d))){ ok = false; break; }
          }
          if(!ok){
            alert("Ese rango incluye fechas reservadas. Elige otras fechas.");
            this.clear();
            startDate = null; endDate = null;
          }
        }

        recalc();
      }
    });

    roomType.addEventListener("change", recalc);
    clearDates.addEventListener("click", () => {
      startDate = null; endDate = null;
      // limpiar flatpickr
      document.querySelector("#calendar")._flatpickr.clear();
      recalc();
    });

    // ====== CONFIRMAR -> PASARELA PAYPAL ======
    confirm.addEventListener("click", () => {
      const nights = calcNights();
      const total = nights * getPricePerNight();

      if(!fullname.value.trim()){
        alert("Escribe tu nombre y apellidos.");
        return;
      }
      if(!email.value.trim() || !email.value.includes("@")){
        alert("Escribe un email válido.");
        return;
      }
      if(!(startDate && endDate && nights > 0)){
        alert("Selecciona fechas válidas.");
        return;
      }

      paypalBox.style.display = "block";

      // Render PayPal Buttons con el TOTAL calculado
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              description: Reserva StayProud (${fmtES(startDate)} - ${fmtES(endDate)}),
              amount: { value: total.toFixed(2) }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            alert("Pago aprobado ✅ Gracias. ID: " + details.id);

            // Aquí puedes marcar el rango como reservado (localStorage o backend)
            // y redirigir a una página de confirmación.
          });
        },
        onError: function(err) {
          console.error(err);
          alert("Hubo un error con PayPal. Revisa la consola (F12).");
        }
      }).render("#paypal-buttons");
    });

    // INIT
    recalc();
  </script>
</body>
</html>